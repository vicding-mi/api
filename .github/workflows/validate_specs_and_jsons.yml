name: Validate SKG-IF Specs and JSON Files

on:
  workflow_dispatch:
#  push:
#    paths:
#      - 'openapi/ver/**/*.json'
#      - 'openapi/ver/**/skg-if-openapi.yaml'
#  pull_request:
#    paths:
#      - 'openapi/ver/**/*.json'
#      - 'openapi/ver/**/skg-if-openapi.yaml'

jobs:
  validate_yaml_files:
    runs-on: ubuntu-latest
    name: Validate YAML Files

    steps:
      - uses: actions/checkout@v4

      # Create a mock event file that mimics the PullRequestEvent structure
      # required by the spectral-action's decoder.
      # It needs 'repository', 'pull_request' (with 'head.sha'), and optionally 'after'.
      - name: Create mock pull request event payload for workflow_dispatch
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          # Use the current commit SHA for pull_request.head.sha and potentially 'after'
          # Repository details are pulled from the GitHub context.
          cat > mock_event.json <<EOF
          {
            "repository": {
              "id": ${{ github.event.repository.id }},
              "node_id": "${{ github.event.repository.node_id }}",
              "name": "${{ github.event.repository.name }}",
              "full_name": "${{ github.repository }}",
              "private": ${{ github.event.repository.private }},
              "owner": {
                "name": "${{ github.event.repository.owner.login }}",
                "email": null, # Owner email might not be available easily
                "login": "${{ github.event.repository.owner.login }}",
                "id": ${{ github.event.repository.owner.id }},
                "node_id": "${{ github.event.repository.owner.node_id }}",
                "avatar_url": "${{ github.event.repository.owner.avatar_url }}",
                "gravatar_id": "${{ github.event.repository.owner.gravatar_id }}",
                "url": "https://api.github.com/users/${{ github.event.repository.owner.login }}",
                "html_url": "https://github.com/${{ github.event.repository.owner.login }}",
                "followers_url": "https://api.github.com/users/${{ github.event.repository.owner.login }}/followers",
                "following_url": "https://api.github.com/users/${{ github.event.repository.owner.login }}/following{/other_user}",
                "gists_url": "https://api.github.com/users/${{ github.event.repository.owner.login }}/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/${{ github.event.repository.owner.login }}/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/${{ github.event.repository.owner.login }}/subscriptions",
                "organizations_url": "https://api.github.com/users/${{ github.event.repository.owner.login }}/orgs",
                "repos_url": "https://api.github.com/users/${{ github.event.repository.owner.login }}/repos",
                "events_url": "https://api.github.com/users/${{ github.event.repository.owner.login }}/events{/privacy}",
                "received_events_url": "https://api.github.com/users/${{ github.event.repository.owner.login }}/received_events",
                "type": "${{ github.event.repository.owner.type }}",
                "site_admin": ${{ github.event.repository.owner.site_admin }}
              },
              "html_url": "${{ github.event.repository.html_url }}",
              "description": "${{ github.event.repository.description }}",
              "fork": ${{ github.event.repository.fork }},
              "url": "${{ github.event.repository.url }}",
              "forks_url": "${{ github.event.repository.forks_url }}",
              "keys_url": "${{ github.event.repository.keys_url }}",
              "collaborators_url": "${{ github.event.repository.collaborators_url }}",
              "teams_url": "${{ github.event.repository.teams_url }}",
              "hooks_url": "${{ github.event.repository.hooks_url }}",
              "issue_events_url": "${{ github.event.repository.issue_events_url }}",
              "events_url": "${{ github.event.repository.events_url }}",
              "assignees_url": "${{ github.event.repository.assignees_url }}",
              "branches_url": "${{ github.event.repository.branches_url }}",
              "tags_url": "${{ github.event.repository.tags_url }}",
              "blobs_url": "${{ github.event.repository.blobs_url }}",
              "git_tags_url": "${{ github.event.repository.git_tags_url }}",
              "git_refs_url": "${{ github.event.repository.git_refs_url }}",
              "trees_url": "${{ github.event.repository.trees_url }}",
              "statuses_url": "${{ github.event.repository.statuses_url }}",
              "languages_url": "${{ github.event.repository.languages_url }}",
              "stargazers_url": "${{ github.event.repository.stargazers_url }}",
              "contributors_url": "${{ github.event.repository.contributors_url }}",
              "subscribers_url": "${{ github.event.repository.subscribers_url }}",
              "subscription_url": "${{ github.event.repository.subscription_url }}",
              "commits_url": "${{ github.event.repository.commits_url }}",
              "git_commits_url": "${{ github.event.repository.git_commits_url }}",
              "comments_url": "${{ github.event.repository.comments_url }}",
              "issue_comment_url": "${{ github.event.repository.issue_comment_url }}",
              "contents_url": "${{ github.event.repository.contents_url }}",
              "compare_url": "${{ github.event.repository.compare_url }}",
              "merges_url": "${{ github.event.repository.merges_url }}",
              "archive_url": "${{ github.event.repository.archive_url }}",
              "downloads_url": "${{ github.event.repository.downloads_url }}",
              "issues_url": "${{ github.event.repository.issues_url }}",
              "pulls_url": "${{ github.event.repository.pulls_url }}",
              "milestones_url": "${{ github.event.repository.milestones_url }}",
              "notifications_url": "${{ github.event.repository.notifications_url }}",
              "labels_url": "${{ github.event.repository.labels_url }}",
              "releases_url": "${{ github.event.repository.releases_url }}",
              "deployments_url": "${{ github.event.repository.deployments_url }}"
            },
            "pull_request": {
              "head": {
                "sha": "${{ github.sha }}" # This is the crucial field the decoder expects
              }
              # Add other minimal PR fields if necessary, but head.sha is key
              # e.g., "base": { "sha": "..." }, "number": 1, "state": "open"
            },
            "after": "${{ github.sha }}" # Optional field according to the schema
          }
          EOF
          echo "Created mock_event.json mimicking PullRequestEvent structure."

      - name: Run Spectral (Dispatch - Mock Pull Request Event)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: stoplightio/spectral-action@latest
        with:
          file_glob: 'openapi/ver/**/skg-if-openapi.yaml'
          spectral_ruleset: .spectral.yaml
        env:
          GITHUB_EVENT_PATH: mock_event.json # Point to the PR-structured mock file

      - if: ${{ failure() }}
        run: exit 1

  validate_json_files:
    runs-on: ubuntu-latest
    name: Validate JSON Files
    needs: validate_yaml_files

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install httpx

      - name: Get changed files for push
        run: |
          LISTED_FILES=$(find openapi/ver/ -name "*.json" -type f -print0 | xargs -0 -r echo)
          echo "CHANGED_FILES=$LISTED_FILES" >> $GITHUB_ENV
          echo "All JSON files in openapi/ver/: $LISTED_FILES"

      - name: Validate changed files
        run: |
          echo "Validating files..."
          python .github/scripts/validate_files.py